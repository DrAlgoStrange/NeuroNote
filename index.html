<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Inkwell â€” Notes</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=DM+Sans:wght@300;400;500&family=DM+Mono&display=swap" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
<style>
  :root {
    --bg:#0d0d0f;--surface:#141417;--panel:#1a1a1f;--border:#2a2a32;
    --accent:#c9a96e;--accent2:#7c6fff;--text:#e8e8ec;--muted:#6b6b7a;
    --danger:#ff6b6b;--success:#6bffb8;--warn:#ffc46b;
    --sidebar:280px;--transition:0.25s cubic-bezier(.4,0,.2,1);
  }
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:15px;overflow:hidden}
  ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:99px}

  #app{display:flex;height:100vh;overflow:hidden}

  /* SIDEBAR */
  #sidebar{width:var(--sidebar);min-width:var(--sidebar);background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;transition:transform var(--transition);z-index:100}
  .sidebar-header{padding:24px 20px 16px;border-bottom:1px solid var(--border)}
  .logo{font-family:'Playfair Display',serif;font-size:22px;color:var(--accent);letter-spacing:.5px;display:flex;align-items:center;gap:10px}
  .logo-dot{width:8px;height:8px;background:var(--accent);border-radius:50%;box-shadow:0 0 8px var(--accent)}
  .sync-status{font-size:11px;color:var(--muted);margin-top:6px;display:flex;align-items:center;gap:6px;cursor:pointer;user-select:none}
  .sync-status:hover{color:var(--text)}
  .sync-dot{width:6px;height:6px;border-radius:50%;background:var(--muted);transition:background var(--transition),box-shadow var(--transition);flex-shrink:0}
  .sync-dot.syncing{background:var(--accent);box-shadow:0 0 6px var(--accent);animation:pulse 1s infinite}
  .sync-dot.ok{background:var(--success);box-shadow:0 0 6px var(--success)}
  .sync-dot.err{background:var(--danger);box-shadow:0 0 6px var(--danger)}
  .sync-dot.warn{background:var(--warn);box-shadow:0 0 6px var(--warn)}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

  .notebooks-section{flex:1;overflow-y:auto;padding:12px 0}
  .section-label{font-size:10px;font-weight:500;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);padding:8px 20px 6px}
  .notebook-item{display:flex;align-items:center;gap:10px;padding:10px 16px;margin:2px 8px;border-radius:12px;cursor:pointer;transition:background var(--transition);user-select:none}
  .notebook-item:hover{background:var(--panel)}
  .notebook-item.active{background:rgba(201,169,110,.12)}
  .notebook-item.active .nb-icon{color:var(--accent)}
  .nb-icon{font-size:18px;width:28px;text-align:center;flex-shrink:0;transition:transform var(--transition)}
  .notebook-item:hover .nb-icon{transform:scale(1.15)}
  .nb-info{flex:1;min-width:0}
  .nb-name{font-size:13.5px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .nb-count{font-size:11px;color:var(--muted);margin-top:1px}
  .nb-del{opacity:0;background:none;border:none;color:var(--danger);cursor:pointer;padding:4px;border-radius:8px;font-size:14px;transition:opacity var(--transition);flex-shrink:0}
  .notebook-item:hover .nb-del{opacity:1}
  .nb-del:hover{background:rgba(255,107,107,.15)}
  .add-notebook-btn{display:flex;align-items:center;gap:8px;padding:10px 16px;margin:4px 8px;border-radius:12px;cursor:pointer;color:var(--muted);font-size:13px;transition:all var(--transition);border:1.5px dashed var(--border)}
  .add-notebook-btn:hover{background:var(--panel);color:var(--text);border-color:var(--muted)}
  .sidebar-footer{padding:12px;border-top:1px solid var(--border);display:flex;gap:8px}
  .icon-btn{flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:9px 12px;border-radius:12px;border:none;background:var(--panel);color:var(--muted);cursor:pointer;font-size:13px;font-family:inherit;transition:all var(--transition)}
  .icon-btn:hover{background:var(--border);color:var(--text)}
  .icon-btn.accent{color:var(--accent)}

  /* NOTES PANEL */
  #notes-panel{width:260px;min-width:260px;background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column}
  .notes-panel-header{padding:20px 16px 12px;border-bottom:1px solid var(--border);display:flex;flex-direction:column;gap:10px}
  .notes-panel-title{font-family:'Playfair Display',serif;font-size:18px;display:flex;align-items:center;justify-content:space-between}
  .search-bar{display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:7px 12px;transition:border-color var(--transition)}
  .search-bar:focus-within{border-color:var(--accent)}
  .search-bar input{background:none;border:none;outline:none;color:var(--text);font-family:inherit;font-size:13px;flex:1;min-width:0}
  .search-bar input::placeholder{color:var(--muted)}
  .notes-list{flex:1;overflow-y:auto;padding:8px}
  .note-card{padding:12px 14px;border-radius:12px;cursor:pointer;margin-bottom:4px;border:1px solid transparent;transition:background var(--transition),border-color var(--transition);animation:fadeUp .2s ease both}
  @keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  .note-card:hover{background:var(--surface)}
  .note-card.active{background:rgba(201,169,110,.1);border-color:rgba(201,169,110,.3)}
  .note-card-title{font-size:13.5px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:4px}
  .note-card-preview{font-size:11.5px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .note-card-date{font-size:10.5px;color:var(--muted);margin-top:6px;opacity:.7}
  .new-note-btn{display:flex;align-items:center;justify-content:center;gap:6px;margin:8px;padding:10px;border-radius:12px;border:1.5px dashed var(--border);background:none;color:var(--muted);cursor:pointer;font-size:13px;font-family:inherit;transition:all var(--transition)}
  .new-note-btn:hover{background:var(--surface);color:var(--accent);border-color:var(--accent)}

  /* EDITOR */
  #editor-area{flex:1;display:flex;flex-direction:column;min-width:0;background:var(--bg)}
  .editor-toolbar{padding:12px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .editor-title{flex:1;background:none;border:none;outline:none;font-family:'Playfair Display',serif;font-size:20px;color:var(--text);min-width:0}
  .editor-title::placeholder{color:var(--border)}
  .toolbar-actions{display:flex;align-items:center;gap:6px}
  .tb-btn{padding:7px 10px;border-radius:10px;border:none;background:var(--panel);color:var(--muted);cursor:pointer;font-size:13px;font-family:inherit;display:flex;align-items:center;gap:5px;transition:background var(--transition),color var(--transition);white-space:nowrap}
  .tb-btn:hover{background:var(--border);color:var(--text)}
  .tb-btn.active{background:rgba(201,169,110,.2);color:var(--accent)}
  .tb-btn.danger:hover{background:rgba(255,107,107,.15);color:var(--danger)}
  .editor-body{flex:1;display:flex;overflow:hidden}
  #md-editor{flex:1;background:none;border:none;outline:none;color:var(--text);font-family:'DM Mono',monospace;font-size:14px;line-height:1.8;padding:28px 36px;resize:none;overflow-y:auto}
  #md-editor::placeholder{color:var(--border)}
  #md-preview{flex:1;padding:28px 36px;overflow-y:auto;display:none}
  #md-preview.visible{display:block;animation:fadeIn .2s ease}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  .md-content h1,.md-content h2,.md-content h3{font-family:'Playfair Display',serif;margin:1.4em 0 .5em;line-height:1.2}
  .md-content h1{font-size:2em;color:var(--accent)}
  .md-content h2{font-size:1.5em;border-bottom:1px solid var(--border);padding-bottom:6px}
  .md-content h3{font-size:1.2em}
  .md-content p{margin:.7em 0;line-height:1.8}
  .md-content ul,.md-content ol{margin:.6em 0 .6em 1.6em}
  .md-content li{margin:.3em 0;line-height:1.7}
  .md-content code{background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:2px 6px;font-family:'DM Mono',monospace;font-size:.85em;color:var(--accent)}
  .md-content pre{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px 20px;overflow-x:auto;margin:1em 0}
  .md-content pre code{background:none;border:none;padding:0;color:var(--text)}
  .md-content blockquote{border-left:3px solid var(--accent);margin:1em 0;padding:6px 0 6px 16px;color:var(--muted);font-style:italic}
  .md-content a{color:var(--accent2)}
  .md-content img{max-width:100%;border-radius:10px;margin:.8em 0}
  .md-content table{width:100%;border-collapse:collapse;margin:1em 0;font-size:13.5px}
  .md-content th{background:var(--panel);padding:8px 12px;border:1px solid var(--border);text-align:left}
  .md-content td{padding:8px 12px;border:1px solid var(--border)}
  .md-content tr:nth-child(even) td{background:rgba(255,255,255,.02)}
  .empty-state{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--muted);gap:12px;text-align:center;padding:40px}
  .empty-icon{font-size:48px;opacity:.3}
  .empty-title{font-family:'Playfair Display',serif;font-size:18px;opacity:.5}
  .empty-sub{font-size:13px;opacity:.4;max-width:240px;line-height:1.6}
  .wc-bar{padding:8px 20px;border-top:1px solid var(--border);font-size:11px;color:var(--muted);display:flex;gap:16px}
  .divider{width:1px;height:20px;background:var(--border);flex-shrink:0}

  /* SETTINGS MODAL */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.78);backdrop-filter:blur(10px);z-index:999;display:flex;align-items:center;justify-content:center;padding:20px;animation:fadeIn .2s ease}
  .modal-overlay.hidden{display:none}
  .modal{background:var(--surface);border:1px solid var(--border);border-radius:20px;width:100%;max-width:500px;display:flex;flex-direction:column;overflow:hidden;max-height:90vh;animation:scaleIn .25s cubic-bezier(.34,1.56,.64,1)}
  @keyframes scaleIn{from{opacity:0;transform:scale(.92)}to{opacity:1;transform:none}}
  .modal-header{padding:22px 24px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
  .modal-title{font-family:'Playfair Display',serif;font-size:19px}
  .modal-body{overflow-y:auto;padding:20px 24px;display:flex;flex-direction:column;gap:16px}
  .modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;flex-shrink:0}

  .form-group{display:flex;flex-direction:column;gap:6px}
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .form-label{font-size:11px;font-weight:500;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
  .form-input{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:11px 14px;color:var(--text);font-family:'DM Mono',monospace;font-size:13px;outline:none;width:100%;transition:border-color var(--transition)}
  .form-input:focus{border-color:var(--accent)}
  .form-input::placeholder{color:var(--muted)}
  .form-hint{font-size:11.5px;color:var(--muted);line-height:1.6}
  .form-hint a{color:var(--accent2);text-decoration:none}
  .form-hint a:hover{text-decoration:underline}
  .token-row{display:flex;gap:8px}
  .token-row .form-input{flex:1}
  .test-btn{padding:0 16px;border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--muted);cursor:pointer;font-family:inherit;font-size:12.5px;white-space:nowrap;transition:all var(--transition);font-weight:500}
  .test-btn:hover{border-color:var(--accent);color:var(--accent)}

  /* Setup steps */
  .setup-steps{background:var(--panel);border-radius:14px;padding:14px 16px;border:1px solid var(--border)}
  .setup-steps-title{font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:10px}
  .setup-step{display:flex;gap:10px;align-items:flex-start;margin-bottom:8px;font-size:12.5px;line-height:1.5;color:var(--muted)}
  .setup-step:last-child{margin-bottom:0}
  .step-num{background:rgba(201,169,110,.15);color:var(--accent);border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;margin-top:1px}
  .setup-step a{color:var(--accent2);text-decoration:none}
  .setup-step a:hover{text-decoration:underline}
  .setup-step strong{color:var(--text)}

  /* Token test result */
  #token-test-result{border-radius:10px;padding:11px 14px;font-size:12.5px;line-height:1.6;display:none;animation:fadeIn .2s ease}
  #token-test-result.ok{background:rgba(107,255,184,.07);border:1px solid rgba(107,255,184,.25);color:var(--success)}
  #token-test-result.err{background:rgba(255,107,107,.07);border:1px solid rgba(255,107,107,.25);color:var(--danger)}
  #token-test-result.warn{background:rgba(255,196,107,.07);border:1px solid rgba(255,196,107,.25);color:var(--warn)}

  .btn{padding:10px 20px;border-radius:12px;border:none;cursor:pointer;font-family:inherit;font-size:13.5px;font-weight:500;transition:all var(--transition)}
  .btn-ghost{background:var(--panel);color:var(--muted)}
  .btn-ghost:hover{background:var(--border);color:var(--text)}
  .btn-accent{background:var(--accent);color:var(--bg)}
  .btn-accent:hover{filter:brightness(1.1);transform:translateY(-1px)}

  /* TOAST */
  #toast-container{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:8px;pointer-events:none}
  .toast{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 18px;font-size:13px;display:flex;align-items:flex-start;gap:10px;animation:slideUp .3s cubic-bezier(.34,1.56,.64,1);box-shadow:0 8px 28px rgba(0,0,0,.45);max-width:340px;transition:opacity .3s,transform .3s;line-height:1.5}
  .toast.ok{border-color:rgba(107,255,184,.3)}
  .toast.err{border-color:rgba(255,107,107,.3)}
  .toast.info{border-color:rgba(201,169,110,.3)}
  .toast.warn{border-color:rgba(255,196,107,.3)}
  @keyframes slideUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}

  /* MOBILE */
  #menu-toggle{display:none;position:fixed;top:14px;left:14px;z-index:200;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:8px 10px;cursor:pointer;font-size:18px;color:var(--text)}
  #overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:90}
  .nb-name-input{background:none;border:none;outline:none;color:var(--text);font-family:inherit;font-size:13.5px;font-weight:500;width:100%;caret-color:var(--accent)}

  @media(max-width:768px){
    #menu-toggle{display:flex}
    #sidebar{position:fixed;left:0;top:0;bottom:0;transform:translateX(-100%)}
    #sidebar.open{transform:none}
    #overlay.open{display:block}
    #notes-panel{min-width:0;width:100%}
    #notes-panel.hidden-mobile{display:none}
    #editor-area.hidden-mobile{display:none}
    #editor-area{width:100%}
    #md-editor,#md-preview{padding:20px 18px}
    .form-row{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div id="overlay" onclick="closeSidebar()"></div>
<button id="menu-toggle" onclick="toggleSidebar()">â˜°</button>

<div id="app">
  <!-- Sidebar -->
  <nav id="sidebar">
    <div class="sidebar-header">
      <div class="logo"><div class="logo-dot"></div>Inkwell</div>
      <div class="sync-status" onclick="manualSync()" title="Click to sync">
        <div class="sync-dot" id="sync-dot"></div>
        <span id="sync-label">Not configured</span>
      </div>
    </div>
    <div class="notebooks-section">
      <div class="section-label">Notebooks</div>
      <div id="notebooks-list"></div>
      <div class="add-notebook-btn" onclick="addNotebook()"><span>ï¼‹</span> New Notebook</div>
    </div>
    <div class="sidebar-footer">
      <button class="icon-btn accent" onclick="manualSync()"><span>â†»</span> Sync</button>
      <button class="icon-btn" onclick="openSettings()">âš™ Config</button>
    </div>
  </nav>

  <!-- Notes panel -->
  <div id="notes-panel">
    <div class="notes-panel-header">
      <div class="notes-panel-title">
        <span id="nb-title">Notes</span>
        <button class="tb-btn" onclick="createNote()" style="padding:6px 8px;">ï¼‹</button>
      </div>
      <div class="search-bar">
        <span style="color:var(--muted);font-size:13px;">âŒ•</span>
        <input id="search-input" type="text" placeholder="Search notesâ€¦" oninput="renderNotesList()" />
      </div>
    </div>
    <div class="notes-list" id="notes-list"></div>
    <button class="new-note-btn" onclick="createNote()">ï¼‹ New note</button>
  </div>

  <!-- Editor -->
  <div id="editor-area">
    <div class="empty-state" id="empty-state">
      <div class="empty-icon">ğŸ““</div>
      <div class="empty-title">Nothing selected</div>
      <div class="empty-sub">Pick a notebook and a note to start writing, or create a new one.</div>
    </div>
    <div id="editor-wrap" style="display:none;flex:1;flex-direction:column;height:100%">
      <div class="editor-toolbar">
        <input id="note-title" class="editor-title" type="text" placeholder="Untitled noteâ€¦" oninput="onTitleChange()" />
        <div class="toolbar-actions">
          <button class="tb-btn" id="preview-btn" onclick="togglePreview()">â—« Preview</button>
          <div class="divider"></div>
          <button class="tb-btn" onclick="insertMd('**','**')"><b>B</b></button>
          <button class="tb-btn" onclick="insertMd('*','*')"><i>I</i></button>
          <button class="tb-btn" onclick="insertMd('\`','\`')">&lt;/&gt;</button>
          <button class="tb-btn" onclick="insertHeading()">H</button>
          <button class="tb-btn" onclick="insertMd('\n- ','')">â˜°</button>
          <div class="divider"></div>
          <button class="tb-btn danger" onclick="deleteNote()">ğŸ—‘</button>
        </div>
      </div>
      <div class="editor-body">
        <textarea id="md-editor" placeholder="Start writing in Markdownâ€¦&#10;&#10;Paste from your PC â€” it syncs to all your devices automatically." oninput="onContentChange()"></textarea>
        <div id="md-preview" class="md-content"></div>
      </div>
      <div class="wc-bar">
        <span id="wc-words">0 words</span>
        <span id="wc-chars">0 chars</span>
        <span id="save-status" style="margin-left:auto;color:var(--accent)"></span>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay hidden" id="settings-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">âš™ GitHub Sync Setup</div>
      <button class="tb-btn" onclick="closeSettings()" style="font-size:16px;">âœ•</button>
    </div>

    <div class="modal-body">
      <div class="setup-steps">
        <div class="setup-steps-title">One-time setup</div>
        <div class="setup-step">
          <div class="step-num">1</div>
          <span>Create a GitHub repo (e.g. <code style="font-size:11.5px;color:var(--accent)">my-notes</code>). Upload <code style="font-size:11.5px;color:var(--accent)">index.html</code> and <code style="font-size:11.5px;color:var(--accent)">notes.json</code> to it, then enable GitHub Pages.</span>
        </div>
        <div class="setup-step">
          <div class="step-num">2</div>
          <span>Go to <a href="https://github.com/settings/tokens/new" target="_blank">github.com/settings/tokens/new</a> â†’ select <strong>Classic</strong> â†’ check the <strong>repo</strong> box (all sub-boxes) â†’ Generate token â†’ copy it.</span>
        </div>
        <div class="setup-step">
          <div class="step-num">3</div>
          <span>Fill in the fields below and hit <strong>Test Token</strong> first to confirm it works, then <strong>Save &amp; Sync</strong>.</span>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">GitHub Username</label>
          <input class="form-input" id="cfg-user" type="text" placeholder="your-username" autocomplete="off" spellcheck="false" />
        </div>
        <div class="form-group">
          <label class="form-label">Repository Name</label>
          <input class="form-input" id="cfg-repo" type="text" placeholder="my-notes" autocomplete="off" spellcheck="false" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Branch</label>
          <input class="form-input" id="cfg-branch" type="text" placeholder="main" />
        </div>
        <div class="form-group">
          <label class="form-label">File Path</label>
          <input class="form-input" id="cfg-path" type="text" placeholder="notes.json" />
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Personal Access Token â€” Classic, <em>repo</em> scope required</label>
        <div class="token-row">
          <input class="form-input" id="cfg-token" type="password" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" autocomplete="off" />
          <button class="test-btn" onclick="testToken()">Test â†’</button>
        </div>
        <div class="form-hint">Saved only in your browser. Only sent to <code style="font-size:11px">api.github.com</code>.</div>
      </div>

      <div id="token-test-result"></div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeSettings()">Cancel</button>
      <button class="btn btn-accent" onclick="saveSettings()">Save &amp; Sync</button>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<script>
// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let db = {notebooks:[],notes:[]};
let cfg = {};
let currentNotebook = null, currentNote = null;
let saveTimer = null, previewMode = false, ghFileSha = null;
const isMobile = () => window.innerWidth <= 768;

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', async () => {
  loadConfig(); loadLocalDB();
  renderNotebooks(); renderNotesList();

  // Mobile back button
  const toolbar = document.querySelector('.editor-toolbar');
  const backBtn = document.createElement('button');
  backBtn.className='tb-btn'; backBtn.id='back-mobile'; backBtn.innerHTML='â€¹';
  backBtn.onclick = () => {
    document.getElementById('notes-panel').classList.remove('hidden-mobile');
    document.getElementById('editor-area').classList.add('hidden-mobile');
  };
  toolbar.prepend(backBtn);
  const checkMobile = () => { backBtn.style.display = isMobile()?'':'none'; };
  window.addEventListener('resize', checkMobile); checkMobile();

  if (cfg.token && cfg.user && cfg.repo) {
    await syncFromGitHub();
  } else {
    setSyncStatus('warn','Not configured â€” click Config');
    openSettings();
  }
  setInterval(silentPull, 45000);
});

// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadConfig() { try { cfg = JSON.parse(localStorage.getItem('inkwell_cfg')||'{}'); } catch { cfg={}; } }
function openSettings() {
  ['user','repo','branch','token','path'].forEach(k => {
    const el = document.getElementById('cfg-'+k);
    if(el) el.value = cfg[k] || (k==='branch'?'main':k==='path'?'notes.json':'');
  });
  const r = document.getElementById('token-test-result');
  r.style.display='none'; r.className='';
  document.getElementById('settings-modal').classList.remove('hidden');
}
function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
function saveSettings() {
  const u=v('cfg-user'),r=v('cfg-repo'),t=v('cfg-token');
  if(!u||!r||!t) { showTestResult('err','âš  Username, repo name and token are all required.'); return; }
  cfg = { user:u, repo:r, branch:v('cfg-branch')||'main', token:t, path:v('cfg-path')||'notes.json' };
  localStorage.setItem('inkwell_cfg', JSON.stringify(cfg));
  closeSettings(); ghFileSha=null;
  toast('Config saved â€” syncing nowâ€¦','info');
  syncFromGitHub();
}
function v(id) { return document.getElementById(id).value.trim(); }

// â”€â”€ TOKEN TESTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function testToken() {
  const user=v('cfg-user'), repo=v('cfg-repo'), token=v('cfg-token');
  if(!token){ showTestResult('err','âš  Paste your token first.'); return; }
  if(!user||!repo){ showTestResult('err','âš  Fill in username and repo name too.'); return; }
  showTestResult('warn','â³ Testing connectionâ€¦');
  try {
    // 1. Check token validity
    const meRes = await fetch('https://api.github.com/user', {
      headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
    });
    if(meRes.status===401){
      showTestResult('err','âœ• <strong>Invalid token</strong> (401). The token may be expired or miscopied. Please regenerate it at github.com/settings/tokens and paste the new one.');
      return;
    }
    const me = await meRes.json();
    if(!me.login){ showTestResult('err','âœ• Could not verify token â€” unexpected response from GitHub.'); return; }

    // 2. Check repo access
    const repoRes = await fetch(`https://api.github.com/repos/${user}/${repo}`, {
      headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
    });
    if(repoRes.status===404){
      showTestResult('err',`âœ• <strong>Repo not found</strong>: "${user}/${repo}". Check the spelling. If the repo is private, make sure the token has the <strong>repo</strong> scope (not just public_repo).`);
      return;
    }
    if(repoRes.status===403||repoRes.status===401){
      showTestResult('err',`âœ• <strong>Permission denied</strong> for "${user}/${repo}". Regenerate your token and check the <strong>repo</strong> checkbox (all sub-boxes). For a private repo you need the full "repo" scope.`);
      return;
    }
    const repoData = await repoRes.json();
    const canPush = repoData.permissions ? repoData.permissions.push : true;
    if(!canPush){
      showTestResult('warn',`âš  Authenticated as <strong>${me.login}</strong> and repo found, but this token appears to be <strong>read-only</strong>. Regenerate with the full <strong>repo</strong> scope to enable writing.`);
      return;
    }
    showTestResult('ok',`âœ“ All good! Authenticated as <strong>${me.login}</strong>. Repo <strong>${repoData.full_name}</strong> is accessible with write permission. Click <strong>Save & Sync</strong>.`);
  } catch(e) {
    showTestResult('err','âœ• Network error â€” check your internet connection. '+e.message);
  }
}

function showTestResult(type, html) {
  const el = document.getElementById('token-test-result');
  el.className=type; el.innerHTML=html; el.style.display='block';
}

// â”€â”€ GITHUB API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ghHeaders = () => ({
  'Authorization': `token ${cfg.token}`,
  'Accept': 'application/vnd.github.v3+json',
  'Content-Type': 'application/json',
});
const ghUrl = () => `https://api.github.com/repos/${cfg.user}/${cfg.repo}/contents/${cfg.path||'notes.json'}`;

async function ghGet() {
  const res = await fetch(ghUrl(), { headers: ghHeaders() });
  if(res.status===404) return {notFound:true};
  if(!res.ok) {
    const b = await res.json().catch(()=>({}));
    let hint = '';
    if(res.status===401) hint=' â€” Token is invalid or expired. Regenerate it.';
    else if(res.status===403) hint=' â€” Token lacks write permission. Regenerate with full "repo" scope.';
    throw new Error(`GitHub ${res.status}: ${b.message||'Error'}${hint}`);
  }
  return res.json();
}

async function ghPut(content, sha, message) {
  const body = { message, content, branch: cfg.branch||'main' };
  if(sha) body.sha = sha;
  const res = await fetch(ghUrl(), { method:'PUT', headers:ghHeaders(), body:JSON.stringify(body) });
  if(!res.ok) {
    const b = await res.json().catch(()=>({}));
    let hint = '';
    if(res.status===401) hint=' â€” Token expired. Open Config and regenerate.';
    else if(res.status===403) hint=' â€” Token does not have write access. Open Config â†’ regenerate token with full "repo" scope checked.';
    else if(res.status===409) hint=' â€” File conflict. Click Sync to fetch latest first.';
    else if(res.status===422) hint=' â€” SHA mismatch. Click Sync to reset.';
    throw new Error(`Save failed (${res.status}): ${b.message||'Error'}${hint}`);
  }
  return res.json();
}

// â”€â”€ SYNC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setSyncStatus(state, label) {
  document.getElementById('sync-dot').className='sync-dot '+state;
  document.getElementById('sync-label').textContent=label;
}

async function syncFromGitHub() {
  if(!cfg.token||!cfg.user||!cfg.repo){ setSyncStatus('warn','Not configured'); return; }
  setSyncStatus('syncing','Syncingâ€¦');
  try {
    const data = await ghGet();
    if(data.notFound) {
      await pushToGitHub('Create notes.json');
      setSyncStatus('ok','Ready Â· '+timeAgo());
      toast('âœ“ Created notes.json in your repo','ok'); return;
    }
    ghFileSha = data.sha;
    const remote = JSON.parse(atob(data.content.replace(/\n/g,'')));
    db = { notebooks: remote.notebooks||[], notes: remote.notes||[] };
    saveLocalDB(); renderNotebooks(); renderNotesList();
    if(currentNote) {
      const n = getNote(currentNote);
      if(n){ document.getElementById('note-title').value=n.title; document.getElementById('md-editor').value=n.content; updateWordCount(); }
      else { currentNote=null; showEditorEmpty(); }
    }
    setSyncStatus('ok','Synced Â· '+timeAgo());
  } catch(e) {
    setSyncStatus('err','Sync failed');
    toast(e.message, 'err');
    console.error(e);
  }
}

async function silentPull() {
  if(!cfg.token||!cfg.user||!cfg.repo) return;
  try {
    const data = await ghGet();
    if(data.notFound||data.sha===ghFileSha) return;
    ghFileSha = data.sha;
    const remote = JSON.parse(atob(data.content.replace(/\n/g,'')));
    db = { notebooks: remote.notebooks||[], notes: remote.notes||[] };
    saveLocalDB(); renderNotebooks(); renderNotesList();
    setSyncStatus('ok','Updated Â· '+timeAgo());
    toast('Notes updated from another device','info');
  } catch { /* silent */ }
}

async function pushToGitHub(msg) {
  if(!cfg.token||!cfg.user||!cfg.repo) return;
  setSyncStatus('syncing','Savingâ€¦');
  try {
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(db,null,2))));
    const res = await ghPut(content, ghFileSha, msg||'Update notes');
    ghFileSha = res.content?.sha || ghFileSha;
    setSyncStatus('ok','Saved Â· '+timeAgo());
    setStatus('âœ“ saved'); setTimeout(()=>setStatus(''),2000);
  } catch(e) {
    setSyncStatus('err','Save failed');
    toast(e.message,'err');
    console.error(e);
  }
}

function scheduleSave() {
  setStatus('â€¢ unsaved'); clearTimeout(saveTimer);
  if(!cfg.token) return;
  saveTimer = setTimeout(()=>pushToGitHub(), 2500);
}

async function manualSync() {
  if(!cfg.token){ openSettings(); return; }
  await syncFromGitHub();
  toast('Sync complete','ok');
}

// â”€â”€ LOCAL DB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadLocalDB() { try { db=JSON.parse(localStorage.getItem('inkwell_db')||'{"notebooks":[],"notes":[]}'); } catch { db={notebooks:[],notes:[]}; } }
function saveLocalDB() { localStorage.setItem('inkwell_db',JSON.stringify(db)); }

// â”€â”€ NOTEBOOKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addNotebook() {
  const nb={id:uid(),name:'Notebook',icon:randomIcon(),created:Date.now()};
  db.notebooks.push(nb); saveLocalDB(); renderNotebooks(); selectNotebook(nb.id); scheduleSave();
  setTimeout(()=>{ const el=document.querySelector(`.notebook-item[data-id="${nb.id}"] .nb-name-input`); if(el){el.focus();el.select();} },80);
}
function selectNotebook(id) {
  currentNotebook=id; currentNote=null;
  document.getElementById('nb-title').textContent=getNotebook(id)?.name||'Notes';
  renderNotebooks(); renderNotesList(); showEditorEmpty();
  if(isMobile()) closeSidebar();
}
function getNotebook(id) { return db.notebooks.find(n=>n.id===id); }
function deleteNotebook(id) {
  if(!confirm('Delete this notebook and all its notes?')) return;
  db.notebooks=db.notebooks.filter(n=>n.id!==id);
  db.notes=db.notes.filter(n=>n.notebookId!==id);
  if(currentNotebook===id){currentNotebook=null;currentNote=null;showEditorEmpty();}
  saveLocalDB(); renderNotebooks(); renderNotesList(); scheduleSave();
}
function renameNotebook(id,name) {
  const nb=getNotebook(id); if(!nb) return;
  nb.name=name.trim()||'Untitled';
  if(currentNotebook===id) document.getElementById('nb-title').textContent=nb.name;
  saveLocalDB(); renderNotebooks(); scheduleSave();
}
function renderNotebooks() {
  const el=document.getElementById('notebooks-list');
  if(!db.notebooks.length){ el.innerHTML=`<div style="padding:10px 20px;font-size:12px;color:var(--muted)">No notebooks yet</div>`; return; }
  el.innerHTML=db.notebooks.map(nb=>{
    const count=db.notes.filter(n=>n.notebookId===nb.id).length;
    const active=currentNotebook===nb.id?'active':'';
    return `<div class="notebook-item ${active}" data-id="${nb.id}" onclick="selectNotebook('${nb.id}')">
      <span class="nb-icon">${nb.icon}</span>
      <div class="nb-info">
        <input class="nb-name-input" value="${escHtml(nb.name)}"
          onclick="event.stopPropagation()" onfocus="event.stopPropagation()"
          onblur="renameNotebook('${nb.id}',this.value)"
          onkeydown="if(event.key==='Enter')this.blur()" />
        <div class="nb-count">${count} note${count!==1?'s':''}</div>
      </div>
      <button class="nb-del" onclick="event.stopPropagation();deleteNotebook('${nb.id}')">âœ•</button>
    </div>`;
  }).join('');
}

// â”€â”€ NOTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function createNote() {
  if(!currentNotebook){toast('Select a notebook first','info');return;}
  const note={id:uid(),notebookId:currentNotebook,title:'',content:'',created:Date.now(),updated:Date.now()};
  db.notes.unshift(note); saveLocalDB(); renderNotesList(); selectNote(note.id); scheduleSave();
  if(isMobile()){document.getElementById('notes-panel').classList.add('hidden-mobile');document.getElementById('editor-area').classList.remove('hidden-mobile');}
  setTimeout(()=>document.getElementById('note-title').focus(),60);
}
function selectNote(id) {
  currentNote=id; const note=getNote(id); if(!note) return;
  document.getElementById('empty-state').style.display='none';
  document.getElementById('editor-wrap').style.display='flex';
  document.getElementById('note-title').value=note.title;
  document.getElementById('md-editor').value=note.content;
  updateWordCount(); renderNotesList();
  if(previewMode) updatePreview();
}
function getNote(id) { return db.notes.find(n=>n.id===id); }
function deleteNote() {
  if(!currentNote||!confirm('Delete this note?')) return;
  db.notes=db.notes.filter(n=>n.id!==currentNote);
  currentNote=null; saveLocalDB(); renderNotesList(); showEditorEmpty(); scheduleSave();
}
function showEditorEmpty() {
  document.getElementById('empty-state').style.display='';
  document.getElementById('editor-wrap').style.display='none';
}
function renderNotesList() {
  const search=document.getElementById('search-input').value.toLowerCase();
  let notes=currentNotebook?db.notes.filter(n=>n.notebookId===currentNotebook):db.notes;
  if(search) notes=notes.filter(n=>(n.title+n.content).toLowerCase().includes(search));
  notes=[...notes].sort((a,b)=>b.updated-a.updated);
  const el=document.getElementById('notes-list');
  if(!notes.length){el.innerHTML=`<div style="padding:20px 14px;font-size:12.5px;color:var(--muted);text-align:center">${search?'No results':'No notes yet'}</div>`;return;}
  el.innerHTML=notes.map((n,i)=>{
    const preview=n.content.replace(/[#*`>\-\[\]!]/g,'').trim().slice(0,60)||'Empty note';
    const active=currentNote===n.id?'active':'';
    return `<div class="note-card ${active}" style="animation-delay:${i*20}ms" onclick="selectNote('${n.id}');if(isMobile())showEditorMobile()">
      <div class="note-card-title">${escHtml(n.title||'Untitled')}</div>
      <div class="note-card-preview">${escHtml(preview)}</div>
      <div class="note-card-date">${relDate(n.updated)}</div>
    </div>`;
  }).join('');
}

// â”€â”€ EDITOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onTitleChange() {
  const note=getNote(currentNote); if(!note) return;
  note.title=document.getElementById('note-title').value;
  note.updated=Date.now(); saveLocalDB(); renderNotesList(); scheduleSave();
}
function onContentChange() {
  const note=getNote(currentNote); if(!note) return;
  note.content=document.getElementById('md-editor').value;
  note.updated=Date.now(); updateWordCount();
  if(previewMode) updatePreview();
  saveLocalDB(); renderNotesList(); scheduleSave();
}
function updatePreview() { document.getElementById('md-preview').innerHTML=marked.parse(document.getElementById('md-editor').value); }
function togglePreview() {
  previewMode=!previewMode;
  const ed=document.getElementById('md-editor'), pv=document.getElementById('md-preview'), btn=document.getElementById('preview-btn');
  if(previewMode){updatePreview();ed.style.display='none';pv.classList.add('visible');btn.classList.add('active');}
  else{ed.style.display='';pv.classList.remove('visible');btn.classList.remove('active');ed.focus();}
}
function insertMd(before,after) {
  const ta=document.getElementById('md-editor'),s=ta.selectionStart,e=ta.selectionEnd;
  ta.setRangeText(before+ta.value.substring(s,e)+after,s,e,'select');
  ta.focus(); onContentChange();
}
function insertHeading() {
  const ta=document.getElementById('md-editor');
  const ls=ta.value.lastIndexOf('\n',ta.selectionStart-1)+1;
  ta.setRangeText('## ',ls,ls,'end'); ta.focus(); onContentChange();
}
function updateWordCount() {
  const txt=document.getElementById('md-editor').value;
  const w=txt.trim()?txt.trim().split(/\s+/).length:0;
  document.getElementById('wc-words').textContent=w+' word'+(w!==1?'s':'');
  document.getElementById('wc-chars').textContent=txt.length+' chars';
}
function setStatus(s){document.getElementById('save-status').textContent=s;}

// â”€â”€ MOBILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('overlay').classList.toggle('open');}
function closeSidebar(){document.getElementById('sidebar').classList.remove('open');document.getElementById('overlay').classList.remove('open');}
function showEditorMobile(){document.getElementById('notes-panel').classList.add('hidden-mobile');document.getElementById('editor-area').classList.remove('hidden-mobile');}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,7);}
function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
const ICONS=['ğŸ““','ğŸ“”','ğŸ“’','ğŸ“•','ğŸ“—','ğŸ“˜','ğŸ“™','ğŸ—’','âœï¸','ğŸ’¡','ğŸ”¬','ğŸ¨','ğŸŒ¿','ğŸš€','ğŸ’¼','ğŸ ','ğŸµ','ğŸ“','ğŸŒ','âš¡','ğŸ§ ','ğŸ—º'];
function randomIcon(){return ICONS[Math.floor(Math.random()*ICONS.length)];}
function relDate(ts){const d=Date.now()-ts;if(d<60000)return 'Just now';if(d<3600000)return Math.floor(d/60000)+'m ago';if(d<86400000)return Math.floor(d/3600000)+'h ago';return new Date(ts).toLocaleDateString();}
function timeAgo(){return new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});}
function toast(msg,type='info'){
  const icons={ok:'âœ“',err:'âœ•',info:'Â·',warn:'âš '};
  const c=document.getElementById('toast-container'),t=document.createElement('div');
  t.className=`toast ${type}`;
  t.innerHTML=`<span style="font-weight:700;flex-shrink:0">${icons[type]||'Â·'}</span><span>${msg}</span>`;
  c.appendChild(t);
  setTimeout(()=>{t.style.opacity='0';t.style.transform='translateY(8px)';setTimeout(()=>t.remove(),350);},5000);
}
</script>
</body>
</html>
